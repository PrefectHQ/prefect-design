name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    # inputs:
    #   release_type:
    #     description: Type of release to perform
    #     required: true
    #     default: patch

jobs:
  build-and-publish:
    name: Build & Publish Release
    runs-on: ubuntu-latest
    environment: 'prod'

    steps:
      # - uses: actions/checkout@v4
      #   with:
      #     fetch-depth: 0

      # - name: Configure git user
      #   run: |
      #     git config user.name "$GITHUB_ACTOR"
      #     git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
      # # Checkout branch, bump version, push, merge, create release
      # - name: Setup Node
      #   id: setup_node
      #   uses: prefecthq/actions-setup-nodejs@main
      
      # - name: Bump Package Version
      #   id: bump_version
      #   run: | 
      #     npm version ${{ inputs.release_type }}
      #     echo "RELEASE_VERSION=$(cat package.json | jq .version | tr -d '"')" >> $GITHUB_ENV

      # - name: Bump Version and Create Release
      #   run: |
      #     git checkout -b $RELEASE_VERSION
      #     git push --set-upstream origin $RELEASE_VERSION
      #     gh pr create --base main -f
      #     gh pr merge --squash
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.PREFECT_CONTENTS_PR_RW }}

      - uses: actions/checkout@v4
        with:
          ref: main

      - uses: prefecthq/actions-release-ui-components@main
        id: release-ui-components
        with:
          NPM_TOKEN: ${{ secrets.PREFECT_UI_COMPONENTS_NPM_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: prefecthq/actions-trigger-downstream-npm-package-updates@main
        id: trigger-downstream-npm-package-update-nebula-ui
        if: ${{ steps.release-ui-components.outputs.type }}
        with:
          GITHUB_TOKEN: ${{ secrets.NEBULA_UI_ACTIONS_RW }}
          DOWNSTREAM_REPO_NAME: nebula-ui
          RELEASE_TAG: ${{ steps.release-ui-components.outputs.version}}

      - uses: prefecthq/actions-trigger-downstream-npm-package-updates@main
        id: trigger-downstream-npm-package-update-prefect-oss
        if: ${{ steps.release-ui-components.outputs.type }}
        with:
          GITHUB_TOKEN: ${{ secrets.PREFECT_ACTIONS_RW }}
          DOWNSTREAM_REPO_NAME: prefect
          RELEASE_TAG: ${{ steps.release-ui-components.outputs.version}}
